<script>
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwHo7ecIYJP-ekEOfsCnD1BUtbSJ_nF6ZNZ2vi_hsQb6fyA0GBurHQTxWbPrm0DKZzOIQ/exec";
  // ऊपर वाली लाइन में अपना नया Apps Script URL डालना मत भूलना

  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  function formatDateTime(iso) {
    if (!iso) return "--";
    const d = new Date(iso);
    return d.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
  }

  async function fetchLiveRank() {
    const roll = getQueryParam("roll");
    const errorBox = document.getElementById("errorBox");

    if (!roll) {
      errorBox.textContent = "URL में ?roll=ROLLNUMBER नहीं मिला।";
      return;
    }

    try {
      errorBox.textContent = "Rank लोड हो रही है...";

      const res = await fetch(`${BACKEND_URL}?roll=${encodeURIComponent(roll)}`);

      // पहले raw text पढ़ते हैं ताकि अगर JSON न हो तो भी पता चले backend क्या भेज रहा है
      const rawText = await res.text();

      if (!res.ok) {
        errorBox.textContent =
          `Backend HTTP ${res.status}. Response (शुरुआत): ` +
          rawText.slice(0, 150) + "...";
        return;
      }

      let data;
      try {
        data = JSON.parse(rawText);
      } catch (jsonErr) {
        errorBox.textContent =
          "Backend ने JSON की जगह कुछ और भेजा है (शुरुआत): " +
          rawText.slice(0, 150) + "...";
        return;
      }

      if (!data || data.error) {
        errorBox.textContent = data && data.error
          ? ("Error: " + data.error)
          : "Backend से empty / invalid JSON आया।";
        return;
      }

      if (!data.user) {
        errorBox.textContent = "इस Roll number का डेटा Sheet में नहीं मिला।";
        return;
      }

      errorBox.textContent = "";

      const u = data.user || {};
      const r = data.ranks || {};
      const stats = data.stats || {};

      document.getElementById("userInfo").innerHTML = `
        <div class="pill"><div class="pill-label">Name</div><div class="pill-value">${u.name || "--"}</div></div>
        <div class="pill"><div class="pill-label">Roll</div><div class="pill-value">${u.roll || "--"}</div></div>
        <div class="pill"><div class="pill-label">Gender</div><div class="pill-value">${u.gender || "--"}</div></div>
        <div class="pill"><div class="pill-label">Category</div><div class="pill-value">${u.category || "--"}</div></div>
        <div class="pill"><div class="pill-label">DOB</div><div class="pill-value">${u.dob || "--"}</div></div>
        <div class="pill"><div class="pill-label">Exam Date</div><div class="pill-value">${u.exam_date || "--"}</div></div>
      `;

      document.getElementById("marksBadge").textContent =
        "Marks: " + (u.cet_marks != null ? u.cet_marks : "--");

      document.getElementById("overallRank").textContent =
        "#" + (r.overallRank || "--");
      document.getElementById("catRank").textContent =
        "#" + (r.categoryRank || "--");
      document.getElementById("genderRank").textContent =
        "#" + (r.genderRank || "--");
      document.getElementById("ageRank").textContent =
        r.ageRank ? ("#" + r.ageRank) : "--";
      document.getElementById("examDateRank").textContent =
        "#" + (r.examDateRank || "--");

      document.getElementById("lastUpdated").textContent =
        "Rank as on: " + formatDateTime(data.rankTime) +
        ` | Total Candidates: ${stats.totalCandidates || "--"}`;
    } catch (err) {
      console.log(err);
      errorBox.textContent = "Network error / Backend issue: " + err.message;
    }
  }

  async function handleShare() {
    const url = window.location.href;
    const text = "मैंने अपना HSSC CET Live Rank यहाँ चेक किया, आप भी अपना देख सकते हैं:";

    try {
      if (navigator.share) {
        await navigator.share({ title: "CET Live Rank", text, url });
      } else {
        await navigator.clipboard.writeText(url);
        alert("लिंक कॉपी किया गया!");
      }
    } catch {}
  }

  fetchLiveRank();
  // चाहो तो auto-refresh रखें, नहीं चाहिए तो ये लाइन हटा सकते हो:
  setInterval(fetchLiveRank, 10000);
</script>
