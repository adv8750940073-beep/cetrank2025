<!DOCTYPE html>
<html lang="hi">
  <head>
    <meta charset="UTF-8" />
    <title>CET Mains – Vacancy-wise Cutoff</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #020617;
        color: #e5e7eb;
        min-height: 100vh;
        padding: 16px;
      }
      .wrapper {
        max-width: 900px;
        margin: 0 auto;
      }
      .header {
        text-align: center;
        margin-bottom: 14px;
      }
      .header h1 {
        margin: 4px 0;
        font-size: 1.2rem;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 9px;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.12);
        border: 1px solid rgba(56, 189, 248, 0.4);
        font-size: 0.7rem;
        color: #bae6fd;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
      }
      .controls input {
        flex: 1;
        min-width: 120px;
        padding: 8px;
        border-radius: 999px;
        border: 1px solid rgba(75, 85, 99, 0.8);
        background: #020617;
        color: #e5e7eb;
        font-size: 0.8rem;
      }
      .controls input.small {
        max-width: 110px;
        flex: 0 0 110px;
      }
      .controls button {
        padding: 8px 16px;
        border-radius: 999px;
        border: none;
        background: linear-gradient(90deg, #2563eb, #4f46e5);
        color: #f9fafb;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
      }
      .controls button:disabled { opacity: 0.6; cursor: default; }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.78rem;
        background: #020617;
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(75, 85, 99, 0.8);
      }
      th, td {
        padding: 6px 7px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.9);
        text-align: left;
      }
      th {
        background: #0f172a;
        font-weight: 600;
        font-size: 0.75rem;
      }
      tr:nth-child(even) td {
        background: rgba(15, 23, 42, 0.9);
      }
      .chip {
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.7rem;
        display: inline-block;
      }
      .chip-gen { background: rgba(55, 65, 81, 0.84); }
      .chip-cat { background: rgba(30, 64, 175, 0.8); }
      .chip-ews { background: rgba(132, 204, 22, 0.8); color: #021013; }

      .info {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-top: 6px;
      }
      .error {
        margin-top: 8px;
        font-size: 0.75rem;
        color: #fecaca;
        background: rgba(127, 29, 29, 0.4);
        border-radius: 10px;
        padding: 8px 10px;
        border: 1px solid rgba(248, 113, 113, 0.7);
        display: none;
      }
      .footer {
        margin-top: 8px;
        font-size: 0.7rem;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="header">
        <div class="badge">CET Mains Cutoff Simulator (Unofficial)</div>
        <h1>Vacancy-wise अनुमानित Cutoff (Category wise)</h1>
      </div>

      <div class="controls">
        <input
          type="text"
          id="vacancyName"
          placeholder="Vacancy नाम लिखें (जैसे: Haryana Police Constable – 5000 post)"
        />
      </div>

      <div class="controls">
        <input
          type="number"
          id="genSeats"
          class="small"
          placeholder="GEN seats"
          min="0"
        />
        <input
          type="number"
          id="scSeats"
          class="small"
          placeholder="SC seats"
          min="0"
        />
        <input
          type="number"
          id="bcaSeats"
          class="small"
          placeholder="BCA seats"
          min="0"
        />
        <input
          type="number"
          id="bcbSeats"
          class="small"
          placeholder="BCB seats"
          min="0"
        />
        <input
          type="number"
          id="ewsSeats"
          class="small"
          placeholder="EWS seats"
          min="0"
        />
        <button id="calcBtn">Cutoff निकालें</button>
      </div>

      <div id="errorBox" class="error"></div>

      <table>
        <thead>
          <tr>
            <th>Category</th>
            <th>Seats</th>
            <th>Sheet में Total Candidates</th>
            <th>अनुमानित Cutoff Marks</th>
          </tr>
        </thead>
        <tbody id="cutoffBody"></tbody>
      </table>

      <p class="info" id="infoText">
        ऊपर हर category के लिए कितना seat है, वो भरकर “Cutoff निकालें” दबाएँ।  
        Cutoff पूरी तरह user-submitted डेटा पर आधारित है, official नहीं है।
      </p>

      <div class="footer" id="footerInfo">
        Sheet total candidates: <span id="totalCandText">--</span> ·
        Last calc: <span id="calcTimeText">--</span>
      </div>
    </div>

    <script>
      // ⬇⬇⬇ यहां अपना Apps Script Web App URL डालें (जो /exec से खत्म होता है) ⬇⬇⬇
      const BACKEND_URL =
        "https://script.google.com/macros/s/AKfycbwHo7ecIYJP-ekEOfsCnD1BUtbSJ_nF6ZNZ2vi_hsQb6fyA0GBurHQTxWbPrm0DKZzOIQ/exec";

      const vacancyNameEl = document.getElementById("vacancyName");
      const genSeatsEl = document.getElementById("genSeats");
      const scSeatsEl = document.getElementById("scSeats");
      const bcaSeatsEl = document.getElementById("bcaSeats");
      const bcbSeatsEl = document.getElementById("bcbSeats");
      const ewsSeatsEl = document.getElementById("ewsSeats");
      const calcBtn = document.getElementById("calcBtn");
      const cutoffBody = document.getElementById("cutoffBody");
      const errorBox = document.getElementById("errorBox");
      const infoText = document.getElementById("infoText");
      const totalCandText = document.getElementById("totalCandText");
      const calcTimeText = document.getElementById("calcTimeText");

      function showError(msg) {
        errorBox.textContent = msg;
        errorBox.style.display = "block";
      }
      function clearError() {
        errorBox.textContent = "";
        errorBox.style.display = "none";
      }

      function renderCategoryChip(cat) {
        let cls = "chip";
        const c = cat.toUpperCase();
        if (c === "GEN") cls += " chip-gen";
        else if (c === "EWS") cls += " chip-ews";
        else cls += " chip-cat";
        return `<span class="${cls}">${c}</span>`;
      }

      function renderCutoffTable(cutoffs) {
        cutoffBody.innerHTML = "";
        const cats = Object.keys(cutoffs || {});
        if (!cats.length) {
          cutoffBody.innerHTML =
            '<tr><td colspan="4">कोई category / seats नहीं मिले। कृपया ऊपर seats भरें।</td></tr>';
          return;
        }
        cats.forEach((cat) => {
          const row = cutoffs[cat];
          const tr = document.createElement("tr");
          const cutoff =
            row.cutoff == null || row.cutoff === "" ? "--" : row.cutoff;
          tr.innerHTML = `
            <td>${renderCategoryChip(cat)}</td>
            <td>${row.seats || 0}</td>
            <td>${row.totalInCategory || 0}</td>
            <td>${cutoff}</td>
          `;
          cutoffBody.appendChild(tr);
        });
      }

      async function calculateCutoff() {
        try {
          clearError();
          infoText.textContent = "Cutoff calculation चल रहा है...";
          calcBtn.disabled = true;
          calcBtn.textContent = "⏳ Calculating...";

          const params = new URLSearchParams();
          params.set("mode", "cutoff");
          const vacancyName = vacancyNameEl.value.trim();
          if (vacancyName) params.set("vacancyName", vacancyName);

          const gen = parseInt(genSeatsEl.value || "0", 10) || 0;
          const sc = parseInt(scSeatsEl.value || "0", 10) || 0;
          const bca = parseInt(bcaSeatsEl.value || "0", 10) || 0;
          const bcb = parseInt(bcbSeatsEl.value || "0", 10) || 0;
          const ews = parseInt(ewsSeatsEl.value || "0", 10) || 0;

          if (gen + sc + bca + bcb + ews === 0) {
            showError("कम से कम किसी एक category में seat भरें।");
            infoText.textContent =
              "Seats भरकर दुबारा “Cutoff निकालें” दबाएँ।";
            return;
          }

          if (gen) params.set("gen", String(gen));
          if (sc) params.set("sc", String(sc));
          if (bca) params.set("bca", String(bca));
          if (bcb) params.set("bcb", String(bcb));
          if (ews) params.set("ews", String(ews));

          const url = BACKEND_URL + "?" + params.toString();
          const res = await fetch(url, { cache: "no-store" });

          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }

          const data = await res.json();
          if (data.error) {
            showError(data.error);
            infoText.textContent = "Error आया, ऊपर message देखें।";
            return;
          }

          renderCutoffTable(data.cutoffs);

          totalCandText.textContent =
            data.totalCandidates != null ? data.totalCandidates : "--";

          if (data.calcTime) {
            try {
              const dt = new Date(data.calcTime);
              calcTimeText.textContent =
                dt.toLocaleDateString("hi-IN") +
                " " +
                dt.toLocaleTimeString("hi-IN", {
                  hour: "2-digit",
                  minute: "2-digit",
                });
            } catch (e) {
              calcTimeText.textContent = data.calcTime;
            }
          } else {
            calcTimeText.textContent = "--";
          }

          infoText.textContent =
            "Cutoff calculation user-submitted data पर आधारित है (Unofficial)।";
        } catch (err) {
          console.log(err);
          showError("Network / Backend error. बाद में दुबारा कोशिश करें।");
          infoText.textContent = "कुछ गड़बड़ हुई, बाद में try करें।";
        } finally {
          calcBtn.disabled = false;
          calcBtn.textContent = "Cutoff निकालें";
        }
      }

      calcBtn.addEventListener("click", calculateCutoff);
    </script>
  </body>
</html>
